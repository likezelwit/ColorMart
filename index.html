<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorMart Chat Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #25D366; /* Warna segar hijau seperti WhatsApp/Line */
            --primary-dark: #128C7E;
            --secondary: #ECE5DD;
            --accent: #34B7F1;
            --text-dark: #303030;
            --text-light: #777;
            --bg-color: #E5DDD5;
            --white: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        /* Sidebar */
        #sidebar {
            width: 320px;
            background: var(--white);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .my-info h3 { font-size: 1rem; margin-bottom: 2px; }
        .my-info span { font-size: 0.75rem; opacity: 0.9; font-family: monospace; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; }

        .sidebar-actions i { margin-left: 15px; cursor: pointer; font-size: 1.1rem; opacity: 0.9; }
        .sidebar-actions i:hover { opacity: 1; }

        /* Search & Add Contact */
        .sidebar-tools {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .input-group {
            display: flex;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        
        .input-group input {
            border: none;
            padding: 10px 15px;
            flex: 1;
            outline: none;
            font-size: 0.9rem;
        }

        .input-group button {
            border: none;
            background: var(--primary);
            color: white;
            padding: 0 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        .input-group button:hover { background: var(--primary-dark); }

        /* Contact List */
        #contact-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .contact-item:hover { background: #f5f5f5; }
        .contact-item.active { background: #e3f2fd; border-left: 4px solid var(--accent); }

        .contact-info h4 { font-size: 0.95rem; color: var(--text-dark); }
        .contact-info p { font-size: 0.8rem; color: var(--text-light); margin-top: 3px; }

        /* Chat Area */
        #chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png') repeat; /* Pattern WhatsApp generic */
            position: relative;
        }

        .chat-header {
            background: var(--primary-dark);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chat-header-info h3 { font-size: 1rem; }
        .chat-header-info span { font-size: 0.8rem; opacity: 0.8; }

        #messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Message Bubbles */
        .msg {
            max-width: 65%;
            padding: 10px 15px;
            border-radius: 8px;
            position: relative;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.received {
            background: white;
            align-self: flex-start;
            border-top-left-radius: 0;
        }

        .msg.sent {
            background: #DCF8C6;
            align-self: flex-end;
            border-top-right-radius: 0;
        }

        .msg-meta {
            display: block;
            text-align: right;
            font-size: 0.7rem;
            color: #555;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
        }

        .msg-meta i { font-size: 0.75rem; color: #3498db; } /* Sent icon */

        .msg-options {
            display: none;
            position: absolute;
            top: 5px;
            right: -30px;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: pointer;
            text-align: center;
            line-height: 24px;
            font-size: 0.8rem;
        }

        .msg.sent:hover .msg-options { display: block; }

        /* Input Area */
        #input-area {
            background: #f0f0f0;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #msg-input {
            flex: 1;
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            outline: none;
            font-size: 0.95rem;
        }

        .btn-send {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-send:hover { background: var(--primary-dark); transform: scale(1.05); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-content h2 { color: var(--primary-dark); margin-bottom: 10px; }
        .modal-content p { color: var(--text-light); margin-bottom: 20px; font-size: 0.9rem; }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            transition: 0.3s;
        }

        .modal-input:focus { border-color: var(--primary); }

        .btn-main {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-main:hover { background: var(--primary-dark); }
        
        /* Notification Dot */
        .notif-dot {
            width: 10px; height: 10px;
            background: red; border-radius: 50%;
            position: absolute; top: 10px; right: 10px;
            display: none;
        }
    </style>
</head>
<body>

<!-- MODAL: Setup Profil Awal -->
<div id="setup-modal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-comments" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
        <h2>Selamat Datang!</h2>
        <p>Masukkan nama Anda untuk memulai percakapan.</p>
        <input type="text" id="setup-name" class="modal-input" placeholder="Nama Panggilan...">
        <button class="btn-main" onclick="setupProfile()">Simpan & Mulai</button>
    </div>
</div>

<!-- MODAL: Tambah Kontak -->
<div id="add-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2><i class="fas fa-user-plus"></i> Tambah Kontak</h2>
        <p style="margin-top: 5px;">Masukkan 13 digit ID teman Anda.</p>
        <input type="number" id="add-id-input" class="modal-input" placeholder="ID Teman (13 Digit)" maxlength="13">
        <div id="search-result" style="margin-bottom: 15px; text-align: left; display:none;">
            <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee;">
                <h4 id="res-name" style="color:var(--text-dark)">-</h4>
                <span id="res-id" style="font-size:0.8rem; color:var(--text-light)">-</span>
            </div>
        </div>
        <button class="btn-main" onclick="searchContact()">Cari Kontak</button>
        <button class="btn-main" id="btn-save-contact" style="display:none; background:var(--accent); margin-top:10px;" onclick="saveContact()">Tambahkan ke Daftar</button>
        <button class="btn-main" style="background:#eee; color:#555; margin-top:10px;" onclick="closeAddModal()">Batal</button>
    </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="sidebar-header">
        <div class="user-profile">
            <div class="avatar" id="my-avatar">?</div>
            <div class="my-info">
                <h3 id="my-name">Loading...</h3>
                <span id="my-id">-</span>
            </div>
        </div>
        <div class="sidebar-actions">
            <i class="fas fa-user-plus" title="Tambah Kontak" onclick="openAddModal()"></i>
        </div>
    </div>

    <div class="sidebar-tools">
        <div class="input-group">
            <input type="text" placeholder="Cari atau mulai chat baru..." disabled title="Fitur cari dalam pengembangan">
            <button disabled><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div id="contact-list">
        <!-- Kontak akan muncul di sini -->
        <div style="padding: 20px; text-align: center; color: #999; font-size: 0.85rem;">
            Belum ada kontak. <br> Klik tombol <i class="fas fa-user-plus"></i> di atas untuk menambah.
        </div>
    </div>
</div>

<!-- CHAT AREA -->
<div id="chat-area">
    <div class="chat-header" id="chat-header" style="display: none;">
        <div class="avatar" style="width: 40px; height: 40px; font-size: 1rem;" id="chat-avatar">?</div>
        <div class="chat-header-info">
            <h3 id="chat-title">Pilih Kontak</h3>
            <span id="chat-status">Online</span>
        </div>
    </div>

    <div id="messages">
        <div style="text-align: center; color: #888; margin: auto; font-size: 0.9rem;">
            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.2;"></i><br>
            Pilih kontak di sidebar untuk memulai chat.
        </div>
    </div>

    <div id="input-area" style="display: none;">
        <input type="text" id="msg-input" placeholder="Ketik pesan..." onkeypress="if(event.key === 'Enter') kirimPesan()">
        <button class="btn-send" onclick="kirimPesan()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<!-- Audio Element untuk Notifikasi -->
<audio id="notif-sound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYZHyRvuAAAAAAD/+9DEAAAIAANIAAAAQgAAaQAAAASX5f//5c0y5cuXLly5cuXLly5cuXLly5cuXLly5cv/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/////////////////////////////////////AAAAADMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz/////////////////////////////////////AAAAAAA="></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
        getDatabase, 
        ref, 
        push, 
        onChildAdded, 
        onChildRemoved,
        get, 
        set, 
        remove, 
        query, 
        orderByChild,
        limitToLast,
        update
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLeX1UZJ_l7eCCGHRHpbj1q-ESCFmkM6g",
        authDomain: "chatme-4d67e.firebaseapp.com",
        projectId: "chatme-4d67e",
        databaseURL: "https://chatme-4d67e-default-rtdb.asia-southeast1.firebasedatabase.app", 
        storageBucket: "chatme-4d67e.firebasestorage.app",
        messagingSenderId: "277442645691",
        appId: "1:277442645691:web:f773cdf216946926b3239e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Variabel Global
    let myId = localStorage.getItem('chatme_id');
    let myName = localStorage.getItem('chatme_name');
    let currentChatTarget = null; // ID target yang sedang dibuka

    // Elemen DOM
    const setupModal = document.getElementById('setup-modal');
    const addModal = document.getElementById('add-modal');
    const notifSound = document.getElementById('notif-sound');

    // Inisialisasi Aplikasi
    function initApp() {
        if (!myId || !myName) {
            // Tampilkan modal setup
            setupModal.style.display = 'flex';
            // Generate ID 13 digit
            const newId = generateNumericId(13);
            document.getElementById('setup-name').value = '';
        } else {
            setupModal.style.display = 'none';
            loadUserProfile();
            loadContacts();
            listenForMessages();
        }
    }

    // Generate ID Numeric
    function generateNumericId(length) {
        let result = '';
        // Pastikan angka pertama bukan 0 agar benar-benar 13 digit valuenya
        result += Math.floor(Math.random() * 9) + 1; 
        for (let i = 1; i < length; i++) {
            result += Math.floor(Math.random() * 10);
        }
        return result;
    }

    // Setup Profil Awal
    window.setupProfile = async () => {
        const nameInput = document.getElementById('setup-name').value.trim();
        if (!nameInput) return alert('Nama harus diisi!');

        // Generate ID baru jika belum ada
        if (!myId) myId = generateNumericId(13);
        
        myName = nameInput;
        
        // Simpan ke Local Storage
        localStorage.setItem('chatme_id', myId);
        localStorage.setItem('chatme_name', myName);

        // Simpan ke Firebase (Users Node)
        await set(ref(db, 'users/' + myId), {
            name: myName,
            timestamp: Date.now()
        });

        setupModal.style.display = 'none';
        initApp(); // Reload app state
    };

    // Load Info User ke UI
    function loadUserProfile() {
        document.getElementById('my-name').innerText = myName;
        document.getElementById('my-id').innerText = myId;
        document.getElementById('my-avatar').innerText = myName.charAt(0);
    }

    // Load Kontak dari LocalStorage
    function loadContacts() {
        const contacts = JSON.parse(localStorage.getItem('chatme_contacts')) || {};
        const listEl = document.getElementById('contact-list');
        
        listEl.innerHTML = '';
        if (Object.keys(contacts).length === 0) {
            listEl.innerHTML = `<div style="padding: 20px; text-align: center; color: #999; font-size: 0.85rem;">Belum ada kontak.</div>`;
            return;
        }

        for (const [id, name] of Object.entries(contacts)) {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.onclick = () => openChat(id, name);
            div.innerHTML = `
                <div class="avatar">${name.charAt(0)}</div>
                <div class="contact-info">
                    <h4>${name}</h4>
                    <p>ID: ${id}</p>
                </div>
            `;
            listEl.appendChild(div);
        }
    }

    // --- Manajemen Kontak ---
    window.openAddModal = () => {
        addModal.style.display = 'flex';
        document.getElementById('add-id-input').value = '';
        document.getElementById('search-result').style.display = 'none';
        document.getElementById('btn-save-contact').style.display = 'none';
    };

    window.closeAddModal = () => {
        addModal.style.display = 'none';
    };

    window.searchContact = async () => {
        const targetId = document.getElementById('add-id-input').value.trim();
        if (targetId.length !== 13 || isNaN(targetId)) return alert("ID harus 13 digit angka!");

        const snapshot = await get(ref(db, 'users/' + targetId));
        if (snapshot.exists()) {
            const data = snapshot.val();
            document.getElementById('res-name').innerText = data.name;
            document.getElementById('res-id').innerText = targetId;
            document.getElementById('search-result').style.display = 'block';
            document.getElementById('btn-save-contact').style.display = 'block';
        } else {
            alert("Pengguna tidak ditemukan!");
        }
    };

    window.saveContact = () => {
        const id = document.getElementById('res-id').innerText;
        const name = document.getElementById('res-name').innerText;

        // Ambil data kontak saat ini
        const contacts = JSON.parse(localStorage.getItem('chatme_contacts')) || {};
        contacts[id] = name;
        localStorage.setItem('chatme_contacts', JSON.stringify(contacts));

        alert("Kontak berhasil ditambahkan!");
        closeAddModal();
        loadContacts();
    };

    // --- Chat Logic ---

    // Buka Chat dengan Seseorang
    function openChat(targetId, targetName) {
        currentChatTarget = targetId;
        
        // UI Adjustments
        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        document.getElementById('chat-title').innerText = targetName;
        document.getElementById('chat-avatar').innerText = targetName.charAt(0);
        document.getElementById('messages').innerHTML = ''; // Clear chat
        
        // Load Chat History
        loadChatHistory(targetId);

        // Highlight active contact
        document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
        // Simple logic to highlight, needs better binding in real app
        event.currentTarget.classList.add('active');
    }

    async function loadChatHistory(targetId) {
        // Path chat gabungan (sorted by ID biar unik)
        // Kita buat "roomId" gabungan ID pengirim & penerima
        // Agar A-B dan B-A masuk ke room yang sama, urutkan ID
        const roomId = [myId, targetId].sort().join('_');
        
        const chatRef = ref(db, 'chats/' + roomId);
        
        // Hapus listener lama jika ada (disederhanakan)
        
        // Load existing messages once
        const snapshot = await get(chatRef);
        if(snapshot.exists()) {
            snapshot.forEach(child => {
                displayMessage(child.key, child.val(), false);
            });
        }

        // Listen for new messages
        onChildAdded(chatRef, (snapshot) => {
            // Cek apakah ini pesan baru atau history, simple trick dengan flag
            const msg = snapshot.val();
            const msgKey = snapshot.key;
            
            // Cek apakah elemen sudah ada (biar tidak double)
            if (!document.getElementById('msg-' + msgKey)) {
                displayMessage(msgKey, msg, true);
            }
        });

        // Listen for deleted messages
        onChildRemoved(chatRef, (snapshot) => {
            const msgEl = document.getElementById('msg-' + snapshot.key);
            if (msgEl) msgEl.remove();
        });
    }

    // Tampilkan Pesan ke UI
    function displayMessage(key, data, playSound) {
        if (!currentChatTarget) return;

        const box = document.getElementById('messages');
        const div = document.createElement('div');
        div.id = 'msg-' + key;
        
        const isMe = data.from === myId;
        const time = new Date(data.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

        div.className = `msg ${isMe ? 'sent' : 'received'}`;
        
        // Konten Pesan
        div.innerHTML = `
            <div>${data.text}</div>
            <div class="msg-meta">
                <span>${time}</span>
                ${isMe ? '<i class="fas fa-check-double"></i>' : ''}
            </div>
        `;

        // Event Hapus (Hanya untuk pengirim)
        if (isMe) {
            div.oncontextmenu = (e) => {
                e.preventDefault();
                if (confirm("Hapus pesan ini untuk semua?")) {
                    hapusPesan(key);
                }
            };
        }

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;

        // Mainkan suara jika bukan dari saya
        if (!isMe && playSound) {
            notifSound.play();
        }
    }

    // Kirim Pesan
    window.kirimPesan = async () => {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !currentChatTarget) return;

        const roomId = [myId, currentChatTarget].sort().join('_');
        
        const msgData = {
            from: myId,
            name: myName,
            text: text,
            timestamp: Date.now()
        };

        // Push ke Firebase
        const newRef = await push(ref(db, 'chats/' + roomId), msgData);
        
        input.value = '';

        // Auto Clean Logic (Dari kode sebelumnya, disesuaikan)
        checkAndClean(roomId);
    };

    // Hapus Pesan
    async function hapusPesan(msgKey) {
        const roomId = [myId, currentChatTarget].sort().join('_');
        await remove(ref(db, `chats/${roomId}/${msgKey}`));
    }

    // Auto Clean Database
    async function checkAndClean(roomId) {
        const chatRef = ref(db, 'chats/' + roomId);
        const snapshot = await get(chatRef);
        
        if (snapshot.exists()) {
            const children = [];
            snapshot.forEach((child) => { children.push(child.key); });
            
            if (children.length > 140) {
                let deleteCount = 10;
                for (let i = 0; i < deleteCount; i++) {
                    remove(ref(db, `chats/${roomId}/${children[i]}`));
                }
                console.log("Database dibersihkan: 10 pesan lama dihapus.");
            }
        }
    }

    // --- Listener Global untuk Pesan Masuk (Notifikasi) ---
    // Catatan: Logic ini agak berat karena listen ke semua path, tapi untuk demo ini oke.
    // Cara ideal pakai Cloud Messaging (FCM), tapi kita buat simple dgn Realtime DB.
    // Kita listen ke node 'chats' lalu filter.
    function listenForMessages() {
        // Karena kita tidak tahu roomId sebelumnya, kita listen ke root 'chats'
        // Ini untuk notifikasi tab lain.
        // NOTE: Ini akan listen SEMUA chat. Untuk optimasi, sebaiknya struktur DB diubah.
        // Tapi untuk demo ini, kita bisa pakai onChildAdded di root dan filter.
        
        // Namun limitasi security rules (jika open) bisa jadi masalah.
        // Alternatif: Listen ke path user sendiri saja jika menggunakan struktur "Inbox".
        // Di kode ini kita gunakan struktur "Room", jadi listen global agak sulit tanpa FCM.
        // Mari kita skip global listener kompleks dan fokus pada listener saat chat dibuka.
    }

    initApp();
</script>
</body>
</html>
