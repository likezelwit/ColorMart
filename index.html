<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorMart Chat Pro V3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --secondary: #ECE5DD;
            --accent: #34B7F1;
            --text-dark: #303030;
            --text-light: #777;
            --white: #ffffff;
            --bg-chat: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            --bg-body: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --primary: #2A2A2A;
            --primary-dark: #1A1A1A;
            --secondary: #121212;
            --text-dark: #e0e0e0;
            --text-light: #a0a0a0;
            --white: #1e1e1e;
            --bg-chat: #1e1e1e;
            --bg-body: #121212;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            display: flex;
            height: 100vh;
            background: var(--bg-body);
            overflow: hidden;
            color: var(--text-dark);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--secondary); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }

        /* Sidebar */
        #sidebar {
            width: 320px;
            background: var(--white);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
            border-right: 1px solid #ddd;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-profile { display: flex; align-items: center; gap: 10px; }

        .avatar {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: white;
        }

        .my-info h3 { font-size: 1rem; margin-bottom: 2px; }
        .my-info span { font-size: 0.75rem; opacity: 0.9; font-family: monospace; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; }

        .sidebar-actions i { margin-left: 15px; cursor: pointer; font-size: 1.1rem; opacity: 0.9; transition: 0.2s; }
        .sidebar-actions i:hover { opacity: 1; transform: scale(1.1); }

        .sidebar-tools {
            padding: 10px 15px;
            background: var(--secondary);
            border-bottom: 1px solid #ddd;
        }

        .input-group {
            display: flex;
            background: var(--white);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .input-group input {
            border: none;
            padding: 10px 15px;
            flex: 1;
            outline: none;
            font-size: 0.9rem;
            background: transparent;
            color: var(--text-dark);
        }

        .input-group button {
            border: none;
            background: var(--primary-dark);
            color: white;
            padding: 0 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        .input-group button:hover { background: var(--primary); }

        #contact-list { flex: 1; overflow-y: auto; }

        .contact-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .contact-item:hover { background: var(--secondary); }
        .contact-item.active { background: var(--primary); color: white; }

        .contact-info h4 { font-size: 0.95rem; color: var(--text-dark); }
        .contact-info p { font-size: 0.8rem; color: var(--text-light); margin-top: 3px; }

        /* Chat Area */
        #chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-chat);
            position: relative;
        }

        .chat-header {
            background: var(--primary-dark);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chat-header-info h3 { font-size: 1rem; }
        .chat-header-info span { font-size: 0.8rem; opacity: 0.8; display: block; height: 18px; }
        .typing-indicator { color: #a5d6a7; font-style: italic; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        #messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Message Bubbles */
        .msg {
            max-width: 65%;
            padding: 10px 15px;
            border-radius: 8px;
            position: relative;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.received {
            background: var(--white);
            align-self: flex-start;
            border-top-left-radius: 0;
        }

        .msg.sent {
            background: #DCF8C6;
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        
        [data-theme="dark"] .msg.sent { background: #2a4f2a; color: #fff; }
        [data-theme="dark"] .msg.received { background: #333; color: #fff; }

        .msg-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 5px;
        }

        .msg-time { font-size: 0.7rem; color: #555; }
        .msg-edited { font-size: 0.65rem; color: #999; margin-right: 5px; font-style: italic; }
        
        /* Reply/Quote Style */
        .quoted-msg {
            border-left: 4px solid var(--accent);
            background: rgba(0,0,0,0.05);
            padding: 5px 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .quoted-msg b { color: var(--primary-dark); }

        /* Ticks */
        .ticks { font-size: 0.85rem; }
        .ticks.grey { color: #9E9E9E; }
        .ticks.blue { color: #3498db; }

        .msg-options {
            display: none;
            position: absolute;
            top: 5px;
            right: -30px;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: pointer;
            text-align: center;
            line-height: 24px;
            font-size: 0.8rem;
            color: #333;
        }

        .msg.sent:hover .msg-options { display: block; }

        /* Input Area */
        #input-area {
            background: var(--secondary);
            padding: 15px;
            display: flex;
            flex-direction: column; /* For reply box */
            gap: 10px;
            border-top: 1px solid #ddd;
        }

        /* Reply Box Container */
        #reply-container {
            display: none;
            background: var(--white);
            padding: 10px;
            border-radius: 10px;
            border-left: 5px solid var(--accent);
            position: relative;
            font-size: 0.85rem;
        }
        #reply-container.active { display: block; }
        #reply-container .close-reply {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            opacity: 0.6;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #msg-input {
            flex: 1;
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            outline: none;
            font-size: 0.95rem;
            background: var(--white);
            color: var(--text-dark);
        }

        .btn-send {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: var(--primary-dark);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-send:hover { background: var(--primary); transform: scale(1.05); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.4s ease;
            color: var(--text-dark);
        }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-content h2 { color: var(--primary-dark); margin-bottom: 10px; }
        .modal-content p { color: var(--text-light); margin-bottom: 20px; font-size: 0.9rem; }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            transition: 0.3s;
            background: var(--secondary);
            color: var(--text-dark);
        }

        .modal-input:focus { border-color: var(--primary); }

        .btn-main {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--primary-dark);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-main:hover { background: var(--primary); }

        /* Context Menu */
        .context-menu {
            position: fixed; /* Changed to fixed for better positioning */
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1000;
            overflow: hidden;
            display: none;
        }
        .context-menu div {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #333;
            text-align: left;
        }
        .context-menu div:hover { background: #f0f0f0; }
        .context-menu div.danger { color: red; }
    </style>
</head>
<body>

<!-- Context Menu (Hidden) -->
<div id="context-menu" class="context-menu">
    <div id="ctx-reply">Balas (Reply)</div>
    <div id="ctx-edit">Edit Pesan</div>
    <div id="ctx-delete" class="danger">Hapus untuk Semua</div>
</div>

<!-- MODAL: Setup Profil -->
<div id="setup-modal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-comments" style="font-size: 3rem; color: var(--primary-dark); margin-bottom: 15px;"></i>
        <h2>Selamat Datang!</h2>
        <p>Masukkan nama Anda untuk memulai.</p>
        <input type="text" id="setup-name" class="modal-input" placeholder="Nama Panggilan...">
        <button class="btn-main" id="btn-setup">Simpan & Mulai</button>
    </div>
</div>

<!-- MODAL: Tambah Kontak -->
<div id="add-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2><i class="fas fa-user-plus"></i> Tambah Kontak</h2>
        <p>Masukkan 13 digit ID teman Anda.</p>
        <input type="number" id="add-id-input" class="modal-input" placeholder="ID Teman (13 Digit)" maxlength="13">
        <div id="search-result" style="margin-bottom: 15px; text-align: left; display:none;">
            <div style="background:var(--secondary); padding:10px; border-radius:8px; border:1px solid #eee;">
                <h4 id="res-name" style="color:var(--text-dark)">-</h4>
                <span id="res-id" style="font-size:0.8rem; color:var(--text-light)">-</span>
            </div>
        </div>
        <button class="btn-main" id="btn-search">Cari Kontak</button>
        <button class="btn-main" id="btn-save-contact" style="display:none; background:var(--accent); margin-top:10px;">Tambahkan</button>
        <button class="btn-main" id="btn-cancel-modal" style="background:#eee; color:#555; margin-top:10px;">Batal</button>
    </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="sidebar-header">
        <div class="user-profile">
            <div class="avatar" id="my-avatar">?</div>
            <div class="my-info">
                <h3 id="my-name">Loading...</h3>
                <span id="my-id">-</span>
            </div>
        </div>
        <div class="sidebar-actions">
            <i class="fas fa-moon" id="dark-mode-toggle" title="Mode Gelap"></i>
            <i class="fas fa-user-plus" id="add-contact-btn" title="Tambah Kontak"></i>
        </div>
    </div>

    <div class="sidebar-tools">
        <div class="input-group">
            <input type="text" placeholder="Cari chat..." disabled>
            <button disabled><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div id="contact-list">
        <div style="padding: 20px; text-align: center; color: var(--text-light); font-size: 0.85rem;">
            Belum ada kontak.
        </div>
    </div>
</div>

<!-- CHAT AREA -->
<div id="chat-area">
    <div class="chat-header" id="chat-header" style="display: none;">
        <div class="avatar" style="width: 40px; height: 40px; font-size: 1rem;" id="chat-avatar">?</div>
        <div class="chat-header-info">
            <h3 id="chat-title">Pilih Kontak</h3>
            <span id="chat-status"></span>
        </div>
    </div>

    <div id="messages">
        <div style="text-align: center; color: #888; margin: auto; font-size: 0.9rem;">
            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.2;"></i><br>
            Pilih kontak untuk memulai chat.
        </div>
    </div>

    <div id="input-area" style="display: none;">
        <div id="reply-container">
            <div id="close-reply-btn" class="close-reply"><i class="fas fa-times"></i></div>
            <div id="reply-text" style="font-weight: bold; color: var(--primary-dark);"></div>
            <div id="reply-preview" style="color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
        </div>
        
        <div class="input-row">
            <input type="text" id="msg-input" placeholder="Ketik pesan...">
            <button class="btn-send" id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<audio id="notif-sound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYZHyRvuAAAAAAD/+9DEAAAIAANIAAAAQgAAaQAAAASX5f//5c0y5cuXLly5cuXLly5cuXLly5cuXLly5cv/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/////////////////////////////////////AAAAADMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz/////////////////////////////////////AAAAAAA="></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
        getDatabase, 
        ref, 
        push, 
        onChildAdded, 
        onChildRemoved,
        onChildChanged,
        onValue, 
        get, 
        set, 
        update,
        remove, 
        serverTimestamp,
        onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLeX1UZJ_l7eCCGHRHpbj1q-ESCFmkM6g",
        authDomain: "chatme-4d67e.firebaseapp.com",
        projectId: "chatme-4d67e",
        databaseURL: "https://chatme-4d67e-default-rtdb.asia-southeast1.firebasedatabase.app", 
        storageBucket: "chatme-4d67e.firebasestorage.app",
        messagingSenderId: "277442645691",
        appId: "1:277442645691:web:f773cdf216946926b3239e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId = localStorage.getItem('chatme_id');
    let myName = localStorage.getItem('chatme_name');
    let currentChatTarget = null;
    let isTargetOnline = false;
    let typingTimeout;
    
    // State untuk Fitur
    let replyingTo = null;
    let editingKey = null;
    let longPressTimer;

    // Listener References (Untuk Cleanup)
    let unsubChatListener = null;
    let unsubStatusListener = null;
    let unsubTypingListener = null;

    const setupModal = document.getElementById('setup-modal');
    const addModal = document.getElementById('add-modal');
    const notifSound = document.getElementById('notif-sound');
    const contextMenu = document.getElementById('context-menu');

    // --- HELPER: Warna Avatar Dinamis ---
    function getColorFromString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const color = Math.abs(hash).toString(16).substring(0, 6);
        return `#${'000000'.substring(0, 6 - color.length)}${color}`;
    }

    function initApp() {
        // Cek Dark Mode
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('dark-mode-toggle').className = 'fas fa-sun';
        }

        if (!myId || !myName) {
            setupModal.style.display = 'flex';
        } else {
            setupModal.style.display = 'none';
            registerPresence();
            loadUserProfile();
            loadContacts();
        }
    }

    function generateNumericId(length) {
        let result = '';
        result += Math.floor(Math.random() * 9) + 1; 
        for (let i = 1; i < length; i++) result += Math.floor(Math.random() * 10);
        return result;
    }

    // --- SETUP & PROFILE ---
    document.getElementById('btn-setup').onclick = async () => {
        const nameInput = document.getElementById('setup-name').value.trim();
        if (!nameInput) return alert('Nama harus diisi!');
        if (!myId) myId = generateNumericId(13);
        myName = nameInput;
        
        localStorage.setItem('chatme_id', myId);
        localStorage.setItem('chatme_name', myName);

        await set(ref(db, 'users/' + myId + '/name'), myName);
        
        setupModal.style.display = 'none';
        initApp();
    };

    // --- PRESENCE & LAST SEEN ---
    function registerPresence() {
        const statusRef = ref(db, 'users/' + myId + '/status');
        set(statusRef, 'online');
        onDisconnect(statusRef).set(serverTimestamp);
        set(ref(db, 'users/' + myId + '/name'), myName);
        onDisconnect(ref(db, 'users/' + myId + '/typingTo')).remove();
    }

    function loadUserProfile() {
        document.getElementById('my-name').innerText = myName;
        document.getElementById('my-id').innerText = myId;
        const av = document.getElementById('my-avatar');
        av.innerText = myName.charAt(0);
        av.style.background = getColorFromString(myName);
        av.style.color = 'white';
    }

    // --- DARK MODE ---
    document.getElementById('dark-mode-toggle').onclick = () => {
        const body = document.body;
        const icon = document.getElementById('dark-mode-toggle');
        if (body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
            icon.className = 'fas fa-moon';
        } else {
            body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
            icon.className = 'fas fa-sun';
        }
    };

    // --- CONTACT MANAGEMENT ---
    function loadContacts() {
        const contactsRef = ref(db, 'users/' + myId + '/contacts');
        onValue(contactsRef, (snapshot) => {
            const listEl = document.getElementById('contact-list');
            listEl.innerHTML = '';
            
            if (!snapshot.exists()) {
                listEl.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-light);">Belum ada kontak.</div>`;
                return;
            }

            snapshot.forEach(child => {
                const id = child.key;
                const name = child.val();
                
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.onclick = () => openChat(id, name, div);
                
                const color = getColorFromString(name);
                
                div.innerHTML = `
                    <div class="avatar" style="background:${color}; color:white;">${name.charAt(0)}</div>
                    <div class="contact-info">
                        <h4>${name}</h4>
                        <p>ID: ${id}</p>
                    </div>
                `;
                listEl.appendChild(div);
            });
        });
    }

    document.getElementById('add-contact-btn').onclick = () => {
        addModal.style.display = 'flex';
        document.getElementById('add-id-input').value = '';
        document.getElementById('search-result').style.display = 'none';
        document.getElementById('btn-save-contact').style.display = 'none';
    };

    document.getElementById('btn-cancel-modal').onclick = () => addModal.style.display = 'none';

    document.getElementById('btn-search').onclick = async () => {
        const targetId = document.getElementById('add-id-input').value.trim();
        if (targetId.length !== 13 || isNaN(targetId)) return alert("ID harus 13 digit angka!");
        if (targetId === myId) return alert("Tidak bisa menambahkan ID sendiri!");

        const contactCheck = await get(ref(db, 'users/' + myId + '/contacts/' + targetId));
        if (contactCheck.exists()) return alert("Kontak sudah ada di daftar!");

        const snapshot = await get(ref(db, 'users/' + targetId + '/name'));
        if (snapshot.exists()) {
            document.getElementById('res-name').innerText = snapshot.val();
            document.getElementById('res-id').innerText = targetId;
            document.getElementById('search-result').style.display = 'block';
            document.getElementById('btn-save-contact').style.display = 'block';
        } else {
            alert("Pengguna tidak ditemukan!");
        }
    };

    document.getElementById('btn-save-contact').onclick = async () => {
        const id = document.getElementById('res-id').innerText;
        const name = document.getElementById('res-name').innerText;
        await set(ref(db, 'users/' + myId + '/contacts/' + id), name);
        alert("Kontak berhasil ditambahkan!");
        addModal.style.display = 'none';
    };

    // --- CHAT LOGIC ---

    function getRoomId(uid1, uid2) {
        return [uid1, uid2].sort().join('_');
    }

    async function openChat(targetId, targetName, elementRef) {
        currentChatTarget = targetId;
        
        // Cleanup previous listeners
        if (unsubChatListener) unsubChatListener();
        if (unsubStatusListener) unsubStatusListener();
        if (unsubTypingListener) unsubTypingListener();

        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        document.getElementById('chat-title').innerText = targetName;
        
        const color = getColorFromString(targetName);
        const chatAv = document.getElementById('chat-avatar');
        chatAv.innerText = targetName.charAt(0);
        chatAv.style.background = color;
        chatAv.style.color = 'white';

        document.getElementById('messages').innerHTML = '';
        document.getElementById('chat-status').innerText = 'Mengecek status...';
        
        cancelReply();
        editingKey = null;

        const roomId = getRoomId(myId, targetId);
        
        loadChatListeners(roomId);
        listenForStatus(targetId);
        
        document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
        if(elementRef) elementRef.classList.add('active');
    }

    function loadChatListeners(roomId) {
        const chatRef = ref(db, 'chats/' + roomId);

        // Load History
        get(chatRef).then(snapshot => {
            if(snapshot.exists()) {
                snapshot.forEach(child => {
                    displayMessage(child.key, child.val(), false);
                });
            }
        });

        // Listen New
        unsubChatListener = onChildAdded(chatRef, (snapshot) => {
            if (!document.getElementById('msg-' + snapshot.key)) {
                displayMessage(snapshot.key, snapshot.val(), true);
                markAsRead(snapshot.key, snapshot.val());
            }
        });

        // Listen Deleted
        onChildRemoved(chatRef, (snapshot) => {
            const msgEl = document.getElementById('msg-' + snapshot.key);
            if (msgEl) msgEl.remove();
        });

        // Listen Edited/Read
        onChildChanged(chatRef, (snapshot) => {
             const msgEl = document.getElementById('msg-' + snapshot.key);
             const data = snapshot.val();
             if (msgEl) {
                 if (data.read) {
                     const ticks = msgEl.querySelector('.ticks');
                     if(ticks) ticks.className = 'fas fa-check-double ticks blue';
                 }
                 if (data.edited) {
                     const textEl = msgEl.querySelector('.text-content');
                     if(textEl) textEl.innerText = data.text;
                     let meta = msgEl.querySelector('.msg-meta');
                     let editedLabel = document.createElement('span');
                     editedLabel.className = 'msg-edited';
                     editedLabel.innerText = 'edited';
                     if(!meta.querySelector('.msg-edited')) meta.insertBefore(editedLabel, meta.firstChild);
                 }
             }
        });
    }

    function listenForStatus(targetId) {
        const statusRef = ref(db, 'users/' + targetId + '/status');
        const statusEl = document.getElementById('chat-status'); // Definisikan di sini
        
        unsubStatusListener = onValue(statusRef, (snapshot) => {
            const status = snapshot.val();
            
            if(status === 'online') {
                isTargetOnline = true;
                statusEl.innerText = 'Online';
                statusEl.className = '';
                statusEl.style.color = '#a5d6a7';
            } else {
                isTargetOnline = false;
                if (status && typeof status === 'number') {
                    const date = new Date(status);
                    const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    const dateStr = date.toLocaleDateString('id-ID');
                    const today = new Date().toLocaleDateString('id-ID');
                    
                    if(dateStr === today) {
                        statusEl.innerText = `Terakhir dilihat hari ini pukul ${timeStr}`;
                    } else {
                        statusEl.innerText = `Terakhir dilihat ${dateStr} ${timeStr}`;
                    }
                } else {
                    statusEl.innerText = 'Offline';
                }
                statusEl.className = '';
                statusEl.style.color = '#ffcc80';
            }
        });

        // Typing
        const typingRef = ref(db, 'users/' + targetId + '/typingTo');
        unsubTypingListener = onValue(typingRef, (snapshot) => {
            // Pastikan statusEl sudah diambil
            const currentStatusEl = document.getElementById('chat-status');
            if(snapshot.val() === myId) {
                currentStatusEl.innerText = 'Mengetik...';
                currentStatusEl.className = 'typing-indicator';
            }
        });
    }

    // --- DISPLAY MESSAGE ---
    function displayMessage(key, data, playSound) {
        if (!currentChatTarget) return;

        const box = document.getElementById('messages');
        const div = document.createElement('div');
        div.id = 'msg-' + key;
        
        const isMe = data.from === myId;
        const time = new Date(data.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

        div.className = `msg ${isMe ? 'sent' : 'received'}`;
        
        let tickHtml = '';
        if (isMe) {
            if (data.read) {
                tickHtml = '<i class="fas fa-check-double ticks blue"></i>';
            } else {
                if (isTargetOnline) tickHtml = '<i class="fas fa-check-double ticks grey"></i>';
                else tickHtml = '<i class="fas fa-check ticks grey"></i>';
            }
        }

        let replyHtml = '';
        if (data.replyTo) {
            replyHtml = `
                <div class="quoted-msg">
                    <b>${data.replyTo.name}</b><br>
                    <span style="color:#666;">${data.replyTo.text.substring(0, 30)}...</span>
                </div>`;
        }

        let editedLabelHtml = data.edited ? '<span class="msg-edited">edited</span>' : '';

        div.innerHTML = `
            ${replyHtml}
            <div class="text-content">${data.text}</div>
            <div class="msg-meta">
                ${editedLabelHtml}
                <span class="msg-time">${time}</span>
                ${tickHtml}
            </div>
        `;

        // Context Menu Trigger
        div.oncontextmenu = (e) => showContextMenu(e, key, data, isMe);

        // Long Press for Mobile
        div.ontouchstart = (e) => {
            longPressTimer = setTimeout(() => showContextMenu(e, key, data, isMe), 500);
        };
        div.ontouchend = () => clearTimeout(longPressTimer);
        div.ontouchmove = () => clearTimeout(longPressTimer);

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;

        if (!isMe && playSound) notifSound.play();
    }

    // --- CONTEXT MENU ACTIONS ---
    let selectedMsgKey = null;
    let selectedMsgData = null;

    function showContextMenu(e, key, data, isMe) {
        e.preventDefault();
        selectedMsgKey = key;
        selectedMsgData = data;
        
        const editOpt = document.getElementById('ctx-edit');
        editOpt.style.display = (isMe) ? 'block' : 'none';

        contextMenu.style.display = 'block';
        
        // Posisi agar tidak keluar layar
        let x = e.pageX || (e.touches && e.touches[0].pageX);
        let y = e.pageY || (e.touches && e.touches[0].pageY);
        
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
        
        document.onclick = () => {
            contextMenu.style.display = 'none';
            document.onclick = null;
        };
    }

    document.getElementById('ctx-reply').onclick = () => {
        if(!selectedMsgData) return;
        replyingTo = { key: selectedMsgKey, ...selectedMsgData };
        document.getElementById('reply-container').classList.add('active');
        document.getElementById('reply-text').innerText = replyingTo.name;
        document.getElementById('reply-preview').innerText = replyingTo.text;
        document.getElementById('msg-input').focus();
    };

    document.getElementById('close-reply-btn').onclick = () => {
        replyingTo = null;
        document.getElementById('reply-container').classList.remove('active');
    };

    document.getElementById('ctx-edit').onclick = () => {
        if(!selectedMsgData || selectedMsgData.from !== myId) return;
        editingKey = selectedMsgKey;
        const input = document.getElementById('msg-input');
        input.value = selectedMsgData.text;
        input.focus();
    };

    document.getElementById('ctx-delete').onclick = async () => {
        if(!selectedMsgKey) return;
        if(confirm("Hapus pesan ini?")) {
            const roomId = getRoomId(myId, currentChatTarget);
            await remove(ref(db, `chats/${roomId}/${selectedMsgKey}`));
        }
    };

    // --- SEND / UPDATE MESSAGE ---
    document.getElementById('send-btn').onclick = async () => {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !currentChatTarget) return;

        const roomId = getRoomId(myId, currentChatTarget);

        if (editingKey) {
            await update(ref(db, 'chats/' + roomId + '/' + editingKey), {
                text: text,
                edited: true
            });
            editingKey = null;
        } else {
            const msgData = {
                from: myId,
                name: myName,
                text: text,
                timestamp: Date.now(),
                read: false
            };

            if (replyingTo) {
                msgData.replyTo = {
                    name: replyingTo.name,
                    text: replyingTo.text
                };
            }

            await push(ref(db, 'chats/' + roomId), msgData);
            
            // Auto-Sync Kontak
            const targetContactRef = ref(db, 'users/' + currentChatTarget + '/contacts/' + myId);
            const snapshot = await get(targetContactRef);
            if (!snapshot.exists()) await set(targetContactRef, myName);

            checkAndClean(roomId);
        }

        input.value = '';
        replyingTo = null;
        document.getElementById('reply-container').classList.remove('active');
        
        set(ref(db, 'users/' + myId + '/typingTo'), null);
    };

    // --- TYPING INDICATOR ---
    document.getElementById('msg-input').onkeypress = (e) => {
        if (e.key === 'Enter') {
            document.getElementById('send-btn').click(); // Trigger send
            return;
        }
        
        // Set typing status
        set(ref(db, 'users/' + myId + '/typingTo'), currentChatTarget);
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            set(ref(db, 'users/' + myId + '/typingTo'), null);
        }, 1000);
    };

    async function markAsRead(msgKey, msgData) {
        if (msgData.from !== myId && !msgData.read) {
            const roomId = getRoomId(myId, currentChatTarget);
            await update(ref(db, 'chats/' + roomId + '/' + msgKey), { read: true });
        }
    }

    async function checkAndClean(roomId) {
        const chatRef = ref(db, 'chats/' + roomId);
        const snapshot = await get(chatRef);
        if (snapshot.exists()) {
            const children = [];
            snapshot.forEach((child) => { children.push(child.key); });
            if (children.length > 140) {
                for (let i = 0; i < 10; i++) {
                    remove(ref(db, `chats/${roomId}/${children[i]}`));
                }
            }
        }
    }

    initApp();
</script>
</body>
</html>
