<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorMart Chat Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --secondary: #ECE5DD;
            --accent: #34B7F1;
            --text-dark: #303030;
            --text-light: #777;
            --bg-color: #E5DDD5;
            --white: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow: hidden;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        /* Sidebar */
        #sidebar {
            width: 320px;
            background: var(--white);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-profile { display: flex; align-items: center; gap: 10px; }

        .avatar {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: var(--white);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .my-info h3 { font-size: 1rem; margin-bottom: 2px; }
        .my-info span { font-size: 0.75rem; opacity: 0.9; font-family: monospace; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; }

        .sidebar-actions i { margin-left: 15px; cursor: pointer; font-size: 1.1rem; opacity: 0.9; transition: 0.2s; }
        .sidebar-actions i:hover { opacity: 1; transform: scale(1.1); }

        .sidebar-tools {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .input-group {
            display: flex;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        
        .input-group input {
            border: none;
            padding: 10px 15px;
            flex: 1;
            outline: none;
            font-size: 0.9rem;
        }

        .input-group button {
            border: none;
            background: var(--primary);
            color: white;
            padding: 0 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        .input-group button:hover { background: var(--primary-dark); }

        #contact-list { flex: 1; overflow-y: auto; }

        .contact-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }

        .contact-item:hover { background: #f5f5f5; }
        .contact-item.active { background: #e3f2fd; border-left: 4px solid var(--accent); }

        .contact-info h4 { font-size: 0.95rem; color: var(--text-dark); }
        .contact-info p { font-size: 0.8rem; color: var(--text-light); margin-top: 3px; }

        /* Chat Area */
        #chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png') repeat;
            position: relative;
        }

        .chat-header {
            background: var(--primary-dark);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chat-header-info h3 { font-size: 1rem; }
        .chat-header-info span { font-size: 0.8rem; opacity: 0.8; display: block; height: 15px; } /* Height for typing text */
        .typing-indicator { color: #a5d6a7; font-style: italic; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        #messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Message Bubbles */
        .msg {
            max-width: 65%;
            padding: 10px 15px;
            border-radius: 8px;
            position: relative;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.received {
            background: white;
            align-self: flex-start;
            border-top-left-radius: 0;
        }

        .msg.sent {
            background: #DCF8C6;
            align-self: flex-end;
            border-top-right-radius: 0;
        }

        .msg-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            margin-top: 5px;
        }

        .msg-time { font-size: 0.7rem; color: #555; }
        
        /* Tick Styles */
        .ticks { font-size: 0.85rem; }
        .ticks.grey { color: #9E9E9E; }
        .ticks.blue { color: #3498db; }

        .msg-options {
            display: none;
            position: absolute;
            top: 5px;
            right: -30px;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: pointer;
            text-align: center;
            line-height: 24px;
            font-size: 0.8rem;
        }

        .msg.sent:hover .msg-options { display: block; }

        /* Input Area */
        #input-area {
            background: #f0f0f0;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #msg-input {
            flex: 1;
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            outline: none;
            font-size: 0.95rem;
        }

        .btn-send {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-send:hover { background: var(--primary-dark); transform: scale(1.05); }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-content h2 { color: var(--primary-dark); margin-bottom: 10px; }
        .modal-content p { color: var(--text-light); margin-bottom: 20px; font-size: 0.9rem; }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            transition: 0.3s;
        }

        .modal-input:focus { border-color: var(--primary); }

        .btn-main {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-main:hover { background: var(--primary-dark); }
    </style>
</head>
<body>

<!-- MODAL: Setup Profil Awal -->
<div id="setup-modal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-comments" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
        <h2>Selamat Datang!</h2>
        <p>Masukkan nama Anda untuk memulai.</p>
        <input type="text" id="setup-name" class="modal-input" placeholder="Nama Panggilan...">
        <button class="btn-main" onclick="setupProfile()">Simpan & Mulai</button>
    </div>
</div>

<!-- MODAL: Tambah Kontak -->
<div id="add-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2><i class="fas fa-user-plus"></i> Tambah Kontak</h2>
        <p style="margin-top: 5px;">Masukkan 13 digit ID teman Anda.</p>
        <input type="number" id="add-id-input" class="modal-input" placeholder="ID Teman (13 Digit)" maxlength="13">
        <div id="search-result" style="margin-bottom: 15px; text-align: left; display:none;">
            <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee;">
                <h4 id="res-name" style="color:var(--text-dark)">-</h4>
                <span id="res-id" style="font-size:0.8rem; color:var(--text-light)">-</span>
            </div>
        </div>
        <button class="btn-main" onclick="searchContact()">Cari Kontak</button>
        <button class="btn-main" id="btn-save-contact" style="display:none; background:var(--accent); margin-top:10px;" onclick="saveContact()">Tambahkan ke Daftar</button>
        <button class="btn-main" style="background:#eee; color:#555; margin-top:10px;" onclick="closeAddModal()">Batal</button>
    </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="sidebar-header">
        <div class="user-profile">
            <div class="avatar" id="my-avatar">?</div>
            <div class="my-info">
                <h3 id="my-name">Loading...</h3>
                <span id="my-id">-</span>
            </div>
        </div>
        <div class="sidebar-actions">
            <i class="fas fa-user-plus" title="Tambah Kontak" onclick="openAddModal()"></i>
        </div>
    </div>

    <div class="sidebar-tools">
        <div class="input-group">
            <input type="text" placeholder="Cari chat..." disabled title="Fitur cari dalam pengembangan">
            <button disabled><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div id="contact-list">
        <div style="padding: 20px; text-align: center; color: #999; font-size: 0.85rem;">
            Belum ada kontak.
        </div>
    </div>
</div>

<!-- CHAT AREA -->
<div id="chat-area">
    <div class="chat-header" id="chat-header" style="display: none;">
        <div class="avatar" style="width: 40px; height: 40px; font-size: 1rem;" id="chat-avatar">?</div>
        <div class="chat-header-info">
            <h3 id="chat-title">Pilih Kontak</h3>
            <span id="chat-status"></span>
        </div>
    </div>

    <div id="messages">
        <div style="text-align: center; color: #888; margin: auto; font-size: 0.9rem;">
            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.2;"></i><br>
            Pilih kontak untuk memulai chat.
        </div>
    </div>

    <div id="input-area" style="display: none;">
        <input type="text" id="msg-input" placeholder="Ketik pesan..." onkeypress="handleTyping(event)">
        <button class="btn-send" onclick="kirimPesan()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<audio id="notif-sound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYZHyRvuAAAAAAD/+9DEAAAIAANIAAAAQgAAaQAAAASX5f//5c0y5cuXLly5cuXLly5cuXLly5cuXLly5cv/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/ly5cuXLly5cuXLly5cuXLly5cuX/y5cuXLly5f+XLly5cuXLly5cuXLly5cuXLly5f/Lly5cuXLl/5cuXLly5cuXLly5cuXLly5cuXLl/8uXLly5cuX/////////////////////////////////////AAAAADMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMz/////////////////////////////////////AAAAAAA="></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
        getDatabase, 
        ref, 
        push, 
        onChildAdded, 
        onChildRemoved,
        onValue, // Untuk listener realtime status
        get, 
        set, 
        update,
        remove, 
        query, 
        onDisconnect,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLeX1UZJ_l7eCCGHRHpbj1q-ESCFmkM6g",
        authDomain: "chatme-4d67e.firebaseapp.com",
        projectId: "chatme-4d67e",
        databaseURL: "https://chatme-4d67e-default-rtdb.asia-southeast1.firebasedatabase.app", 
        storageBucket: "chatme-4d67e.firebasestorage.app",
        messagingSenderId: "277442645691",
        appId: "1:277442645691:web:f773cdf216946926b3239e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId = localStorage.getItem('chatme_id');
    let myName = localStorage.getItem('chatme_name');
    let currentChatTarget = null;
    let isTyping = false;
    let typingTimeout;

    const setupModal = document.getElementById('setup-modal');
    const addModal = document.getElementById('add-modal');
    const notifSound = document.getElementById('notif-sound');

    function initApp() {
        if (!myId || !myName) {
            setupModal.style.display = 'flex';
        } else {
            setupModal.style.display = 'none';
            registerPresence(); // Setup online status
            loadUserProfile();
            loadContacts();
        }
    }

    function generateNumericId(length) {
        let result = '';
        result += Math.floor(Math.random() * 9) + 1; 
        for (let i = 1; i < length; i++) result += Math.floor(Math.random() * 10);
        return result;
    }

    window.setupProfile = async () => {
        const nameInput = document.getElementById('setup-name').value.trim();
        if (!nameInput) return alert('Nama harus diisi!');
        if (!myId) myId = generateNumericId(13);
        myName = nameInput;
        
        localStorage.setItem('chatme_id', myId);
        localStorage.setItem('chatme_name', myName);

        // Simpan nama ke DB agar bisa dicari orang lain
        await set(ref(db, 'users/' + myId + '/name'), myName);
        
        setupModal.style.display = 'none';
        initApp();
    };

    // --- PRESENCE SYSTEM (Online/Offline) ---
    function registerPresence() {
        const statusRef = ref(db, 'users/' + myId + '/status');
        // Set online saat buka aplikasi
        set(statusRef, 'online');
        
        // Set offline saat tutup aplikasi/disconnect
        onDisconnect(statusRef).set('offline');

        // Sync nama jika berubah
        set(ref(db, 'users/' + myId + '/name'), myName);
    }

    function loadUserProfile() {
        document.getElementById('my-name').innerText = myName;
        document.getElementById('my-id').innerText = myId;
        document.getElementById('my-avatar').innerText = myName.charAt(0);
    }

    // --- CONTACT MANAGEMENT ---
    
    // Load kontak dari Firebase (Realtime)
    function loadContacts() {
        const contactsRef = ref(db, 'users/' + myId + '/contacts');
        onValue(contactsRef, (snapshot) => {
            const listEl = document.getElementById('contact-list');
            listEl.innerHTML = '';
            
            if (!snapshot.exists()) {
                listEl.innerHTML = `<div style="padding: 20px; text-align: center; color: #999; font-size: 0.85rem;">Belum ada kontak.</div>`;
                return;
            }

            snapshot.forEach(child => {
                const id = child.key;
                const name = child.val(); // Nama yang tersimpan
                
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.onclick = () => openChat(id, name);
                div.innerHTML = `
                    <div class="avatar">${name.charAt(0)}</div>
                    <div class="contact-info">
                        <h4>${name}</h4>
                        <p>ID: ${id}</p>
                    </div>
                `;
                listEl.appendChild(div);
            });
        });
    }

    window.openAddModal = () => {
        addModal.style.display = 'flex';
        document.getElementById('add-id-input').value = '';
        document.getElementById('search-result').style.display = 'none';
        document.getElementById('btn-save-contact').style.display = 'none';
    };

    window.closeAddModal = () => addModal.style.display = 'none';

    window.searchContact = async () => {
        const targetId = document.getElementById('add-id-input').value.trim();
        if (targetId.length !== 13 || isNaN(targetId)) return alert("ID harus 13 digit angka!");

        const snapshot = await get(ref(db, 'users/' + targetId + '/name'));
        if (snapshot.exists()) {
            document.getElementById('res-name').innerText = snapshot.val();
            document.getElementById('res-id').innerText = targetId;
            document.getElementById('search-result').style.display = 'block';
            document.getElementById('btn-save-contact').style.display = 'block';
        } else {
            alert("Pengguna tidak ditemukan!");
        }
    };

    window.saveContact = async () => {
        const id = document.getElementById('res-id').innerText;
        const name = document.getElementById('res-name').innerText;
        // Simpan kontak ke Firebase di node user kita
        await set(ref(db, 'users/' + myId + '/contacts/' + id), name);
        alert("Kontak berhasil ditambahkan!");
        closeAddModal();
    };

    // --- CHAT LOGIC ---

    function getRoomId(uid1, uid2) {
        return [uid1, uid2].sort().join('_');
    }

    async function openChat(targetId, targetName) {
        currentChatTarget = targetId;
        
        document.getElementById('chat-header').style.display = 'flex';
        document.getElementById('input-area').style.display = 'flex';
        document.getElementById('chat-title').innerText = targetName;
        document.getElementById('chat-avatar').innerText = targetName.charAt(0);
        document.getElementById('messages').innerHTML = '';
        document.getElementById('chat-status').innerText = 'Mengecek status...';

        const roomId = getRoomId(myId, targetId);
        
        // 1. Load Chat History
        const chatRef = ref(db, 'chats/' + roomId);
        const snapshot = await get(chatRef);
        if(snapshot.exists()) {
            snapshot.forEach(child => {
                displayMessage(child.key, child.val(), false);
            });
        }

        // 2. Listen New Messages
        onChildAdded(chatRef, (snapshot) => {
            if (!document.getElementById('msg-' + snapshot.key)) {
                displayMessage(snapshot.key, snapshot.val(), true);
                // Set pesan sebagai sudah dibaca jika chat terbuka
                markAsRead(snapshot.key, snapshot.val());
            }
        });

        // 3. Listen Deleted Messages
        onChildRemoved(chatRef, (snapshot) => {
            const msgEl = document.getElementById('msg-' + snapshot.key);
            if (msgEl) msgEl.remove();
        });

        // 4. Listen Status Online/Offline Lawan
        onValue(ref(db, 'users/' + targetId + '/status'), (snapshot) => {
            const status = snapshot.val();
            const statusEl = document.getElementById('chat-status');
            if(status === 'online') {
                statusEl.innerText = 'Online';
                statusEl.style.color = '#a5d6a7';
            } else {
                statusEl.innerText = 'Offline';
                statusEl.style.color = '#ffcc80';
            }
        });

        // 5. Listen Typing Status
        onValue(ref(db, 'users/' + targetId + '/typingTo'), (snapshot) => {
            const typingTarget = snapshot.val();
            const statusEl = document.getElementById('chat-status');
            // Hanya tampilin jika statusnya bukan 'Online' (biar tidak flicker)
            // Atapi kita timpa saja
            if(typingTarget === myId) {
                statusEl.innerText = 'Mengetik...';
                statusEl.className = 'typing-indicator';
            } else {
                // Kembalikan ke status semula (perlu refresh status online)
                // Sederhananya: biar logika status online di atas handle ini dengan detik timeout kecil
                setTimeout(() => {
                     // refresh status dipicu oleh listener status online
                }, 1000);
            }
        });
        
        // Highlight active contact
        document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // Tampilkan Pesan
    function displayMessage(key, data, playSound) {
        if (!currentChatTarget) return;

        const box = document.getElementById('messages');
        const div = document.createElement('div');
        div.id = 'msg-' + key;
        
        const isMe = data.from === myId;
        const time = new Date(data.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

        div.className = `msg ${isMe ? 'sent' : 'received'}`;
        
        // Logika Tick
        let tickHtml = '';
        if (isMe) {
            if (data.read) {
                // 2 Biru (Dibaca)
                tickHtml = '<i class="fas fa-check-double ticks blue"></i>';
            } else {
                // Jika belum dibaca, cek status lawan (Logika sederhana: 
                // Kita tidak bisa cek status lawan di momen ini tanpa listener tambahan, 
                // jadi kita asumsikan:
                // 1 Centang Abu = Terkirim ke server. 
                // 2 Centang Abu = Terkirim ke device (Jika lawan online).
                // Untuk simplicity demo: 1 centang abu default, 2 biru kalo udah read.
                // Kita buat logic: Jika lawan online -> 2 Abu. Jika offline -> 1 Abu.
                // Kita butuh cek status lawan di sini.
                
                // *Optimasi: Kita skip cek realtime per pesan untuk beban DB, 
                // Kita pakai logic: Default 1 Abu. Nanti update listener.
                
                tickHtml = '<i class="fas fa-check ticks grey"></i>'; // Default 1 Abu
            }
        }

        div.innerHTML = `
            <div>${data.text}</div>
            <div class="msg-meta">
                <span class="msg-time">${time}</span>
                ${tickHtml}
            </div>
        `;

        if (isMe) {
            div.oncontextmenu = (e) => {
                e.preventDefault();
                if (confirm("Hapus pesan ini untuk semua?")) {
                    hapusPesan(key);
                }
            };
        }

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;

        if (!isMe && playSound) {
            notifSound.play();
        }
    }

    // Logika Read Receipt & Ticks Update
    async function markAsRead(msgKey, msgData) {
        if (msgData.from !== myId && !msgData.read) {
            const roomId = getRoomId(myId, currentChatTarget);
            // Update status read di DB
            await update(ref(db, 'chats/' + roomId + '/' + msgKey), { read: true });
        }
    }

    // Update UI Centang saat ada perubahan data pesan (Read)
    function listenForReadStatus(roomId) {
        // Listener ini bisa ditambahkan spesifik per pesan, tapi untuk hemat resource
        // kita bisa bind onChildChanged
        import { onChildChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        
        onChildChanged(ref(db, 'chats/' + roomId), (snapshot) => {
             const msgEl = document.getElementById('msg-' + snapshot.key);
             if (msgEl && snapshot.val().read) {
                 // Ubah centang jadi 2 biru
                 const ticks = msgEl.querySelector('.ticks');
                 if(ticks) {
                     ticks.className = 'fas fa-check-double ticks blue';
                 }
             }
        });
    }
    // Panggil di openChat
    const originalOpenChat = openChat;
    openChat = function(id, name) {
        originalOpenChat(id, name);
        listenForReadStatus(getRoomId(myId, id));
    }

    // --- KIRIM PESAN ---
    window.kirimPesan = async () => {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !currentChatTarget) return;

        const roomId = getRoomId(myId, currentChatTarget);
        
        const msgData = {
            from: myId,
            name: myName,
            text: text,
            timestamp: Date.now(),
            read: false
        };

        // 1. Push Message
        await push(ref(db, 'chats/' + roomId), msgData);
        input.value = '';
        
        // 2. Auto-Sync Kontak: 
        // Jika saya chat dia, saya otomatis masuk ke kontak dia dengan nama saya.
        // Ini memastikan dia bisa reply meski belum save kontak saya.
        const targetContactRef = ref(db, 'users/' + currentChatTarget + '/contacts/' + myId);
        const snapshot = await get(targetContactRef);
        if (!snapshot.exists()) {
             await set(targetContactRef, myName); // Simpan ID saya di kontak dia
        }

        // 3. Clean DB
        checkAndClean(roomId);
        
        // 4. Stop typing status
        set(ref(db, 'users/' + myId + '/typingTo'), null);
    };

    // --- TYPING INDICATOR ---
    window.handleTyping = (e) => {
        if (e.key === 'Enter') return; // Abaikan enter
        
        // Set status mengetik ke DB
        set(ref(db, 'users/' + myId + '/typingTo'), currentChatTarget);
        
        // Reset timer
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            set(ref(db, 'users/' + myId + '/typingTo'), null);
        }, 1500); // Setelah 1.5 detik diam, anggap selesai mengetik
    };

    async function hapusPesan(msgKey) {
        const roomId = getRoomId(myId, currentChatTarget);
        await remove(ref(db, `chats/${roomId}/${msgKey}`));
    }

    async function checkAndClean(roomId) {
        const chatRef = ref(db, 'chats/' + roomId);
        const snapshot = await get(chatRef);
        if (snapshot.exists()) {
            const children = [];
            snapshot.forEach((child) => { children.push(child.key); });
            if (children.length > 140) {
                for (let i = 0; i < 10; i++) {
                    remove(ref(db, `chats/${roomId}/${children[i]}`));
                }
            }
        }
    }

    initApp();
</script>
</body>
</html>
